<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Location Tracking - OpenStreetMap</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            position: relative;
        }

        .header h1 {
            font-size: 1.8em;
            margin: 0;
            display: inline-block;
        }

        .header-controls {
            float: right;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .connection-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 2px solid #28a745;
        }

        .connection-status.disconnected {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 2px solid #dc3545;
        }

        .connection-status.connecting {
            background: rgba(255, 193, 7, 0.2);
            color: #856404;
            border: 2px solid #ffc107;
        }

        .stats-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.9em;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .stat-item .icon {
            font-size: 1.2em;
        }

        .map-container {
            position: relative;
            height: calc(100vh - 120px);
            width: 100%;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .device-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            max-width: 350px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .device-panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .device-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #ddd;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .device-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .device-item.online {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #e8f8f5 0%, #d1f2eb 100%);
        }

        .device-item.offline {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fdf2f2 0%, #fadbd8 100%);
        }

        .device-item.selected {
            border-left-color: #667eea;
            background: linear-gradient(135deg, #e8ecff 0%, #d4e3ff 100%);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .device-item.tracking {
            border-left-color: #ff6b35;
            background: linear-gradient(135deg, #fff3e6 0%, #ffe5cc 100%);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            animation: trackingPulse 2s infinite;
        }

        @keyframes trackingPulse {
            0%, 100% { box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3); }
            50% { box-shadow: 0 6px 18px rgba(255, 107, 53, 0.5); }
        }

        .device-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .device-status {
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .device-status.online {
            background: #28a745;
            color: white;
        }

        .device-status.offline {
            background: #dc3545;
            color: white;
        }

        .device-status.tracking {
            background: #ff6b35;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .device-info {
            font-size: 0.85em;
            color: #666;
            line-height: 1.4;
        }

        .device-info strong {
            color: #333;
        }

        .device-actions {
            margin-top: 8px;
            display: flex;
            gap: 5px;
        }

        .device-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .device-btn.focus {
            background: #667eea;
            color: white;
        }

        .device-btn.focus:hover {
            background: #5a6fd8;
        }

        .device-btn.track {
            background: #ff6b35;
            color: white;
        }

        .device-btn.track:hover {
            background: #e55a2b;
        }

        .device-btn.track.active {
            background: #dc3545;
            animation: pulse 1s infinite;
        }

        .controls-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .control-btn {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 8px;
            border: none;
            border-radius: 6px;
            background: #667eea;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .control-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .control-btn:last-child {
            margin-bottom: 0;
        }

        .control-btn.secondary {
            background: #6c757d;
        }

        .control-btn.secondary:hover {
            background: #5a6268;
        }

        .control-btn.danger {
            background: #dc3545;
        }

        .control-btn.danger:hover {
            background: #c82333;
        }

        .control-btn.tracking-active {
            background: #ff6b35;
            animation: pulse 2s infinite;
        }

        .trail-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: #ddd;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #28a745;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        .tracking-controls {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(255, 107, 53, 0.3);
        }

        .tracking-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            font-weight: 600;
            color: #ff6b35;
            margin-bottom: 8px;
        }

        .tracking-device-name {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
        }

        .location-info-popup {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            backdrop-filter: blur(10px);
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .location-info-popup.show {
            transform: translateY(0);
            opacity: 1;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .popup-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .popup-close:hover {
            background: #f8f9fa;
            color: #333;
        }

        .location-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.9em;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
            margin-bottom: 2px;
        }

        .detail-value {
            font-family: 'Courier New', monospace;
            color: #333;
            background: rgba(102, 126, 234, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #fff;
            border-left: 4px solid #667eea;
            border-radius: 6px;
            padding: 15px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 2000;
            max-width: 350px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.success { border-left-color: #28a745; }
        .notification.error { border-left-color: #dc3545; }
        .notification.warning { border-left-color: #ffc107; }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Custom Leaflet styles */
        .device-marker {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .device-marker.online {
            background: #28a745;
        }

        .device-marker.offline {
            background: #dc3545;
        }

        .device-marker.tracking {
            background: #ff6b35;
            animation: markerPulse 1.5s infinite;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.6);
            border: 3px solid #fff;
        }

        @keyframes markerPulse {
            0% { 
                transform: scale(1); 
                box-shadow: 0 0 20px rgba(255, 107, 53, 0.6);
            }
            50% { 
                transform: scale(1.1); 
                box-shadow: 0 0 30px rgba(255, 107, 53, 0.8);
            }
            100% { 
                transform: scale(1); 
                box-shadow: 0 0 20px rgba(255, 107, 53, 0.6);
            }
        }

        .direction-indicator {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .leaflet-popup-content {
            margin: 15px;
            line-height: 1.4;
        }

        .tracking-trail {
            animation: trailFlow 2s linear infinite;
        }

        @keyframes trailFlow {
            0% { stroke-dashoffset: 0; }
            100% { stroke-dashoffset: -20; }
        }

        @media (max-width: 768px) {
            .device-panel, .controls-panel {
                position: relative;
                max-width: none;
                margin: 10px;
                max-height: 300px;
            }

            .map-container {
                height: calc(100vh - 200px);
            }

            .header-controls {
                float: none;
                margin-top: 10px;
            }

            .location-info-popup {
                left: 10px;
                right: 10px;
                bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üó∫Ô∏è Real-time Location Tracking</h1>
        <div class="header-controls">
            <div id="connectionStatus" class="connection-status connecting">
                üîÑ Connecting...
            </div>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-item">
            <span class="icon">üì±</span>
            <span>Devices: <span id="deviceCount">0</span></span>
        </div>
        <div class="stat-item">
            <span class="icon">üü¢</span>
            <span>Online: <span id="onlineCount">0</span></span>
        </div>
        <div class="stat-item">
            <span class="icon">üìç</span>
            <span>Updates: <span id="updateCount">0</span></span>
        </div>
        <div class="stat-item">
            <span class="icon">üéØ</span>
            <span>Tracking: <span id="trackingCount">0</span></span>
        </div>
        <div class="stat-item">
            <span class="icon">‚è∞</span>
            <span>Uptime: <span id="uptime">00:00:00</span></span>
        </div>
    </div>

    <div class="map-container">
        <div id="map"></div>
        
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>

        <div class="device-panel">
            <h3>üì± Connected Devices</h3>
            <div id="deviceList">
                <div style="text-align: center; padding: 20px; color: #666;">
                    <div style="font-size: 2em; margin-bottom: 10px;">üì°</div>
                    <div>Waiting for devices...</div>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            <div id="trackingControls" class="tracking-controls" style="display: none;">
                <div class="tracking-indicator">
                    üéØ Live Tracking Active
                </div>
                <div class="tracking-device-name" id="trackingDeviceName">
                    Device Name
                </div>
                <button class="control-btn danger" onclick="dashboard.stopTracking()">
                    ‚èπÔ∏è Stop Tracking
                </button>
            </div>
            
            <div class="trail-toggle">
                <span style="font-weight: 600; color: #333;">Show Trails</span>
                <div id="trailToggle" class="toggle-switch active"></div>
            </div>
            <button class="control-btn" onclick="dashboard.centerAllDevices()">
                üéØ Center All
            </button>
            <button class="control-btn" onclick="dashboard.refreshData()">
                üîÑ Refresh
            </button>
            <button class="control-btn" onclick="dashboard.autoFollowOnline()">
                üöó Follow Online
            </button>
            <button class="control-btn secondary" onclick="dashboard.clearTrails()">
                üßπ Clear Trails
            </button>
            <button class="control-btn danger" onclick="dashboard.clearAllData()">
                üóëÔ∏è Clear All
            </button>
        </div>

        <div class="location-info-popup" id="locationPopup">
            <div class="popup-header">
                <h4 id="popupTitle">Location Details</h4>
                <button class="popup-close" onclick="dashboard.hideLocationPopup()">√ó</button>
            </div>
            <div class="location-details" id="popupDetails">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        class RealtimeMapDashboard {
            constructor() {
                this.map = null;
                this.websocket = null;
                this.devices = new Map();
                this.deviceMarkers = new Map();
                this.deviceTrails = new Map();
                this.locationUpdates = 0;
                this.showTrails = true;
                this.selectedDevice = null;
                this.trackedDevice = null;
                this.isTracking = false;
                this.autoFollow = false;
                this.trackingZoom = 16;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.lastTrackingUpdate = null;
                this.trackingSmoothness = 0.3; // Smooth map movement
                
                this.init();
            }

            async init() {
                try {
                    await this.initMap();
                    this.setupEventListeners();
                    this.connectWebSocket();
                    this.startPeriodicUpdates();
                    this.hideLoadingOverlay();
                    
                    console.log('üó∫Ô∏è Real-time Map Dashboard initialized');
                } catch (error) {
                    console.error('‚ùå Failed to initialize dashboard:', error);
                    this.showNotification('Failed to initialize dashboard', 'error');
                }
            }

            async initMap() {
                // Initialize map centered on Jakarta, Indonesia
                this.map = L.map('map', {
                    center: [-6.2088, 106.8456],
                    zoom: 11,
                    zoomControl: false,
                    preferCanvas: true // Better performance for tracking
                });

                // Add zoom control to top right
                L.control.zoom({
                    position: 'topright'
                }).addTo(this.map);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetMap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(this.map);

                // Add scale control
                L.control.scale({
                    position: 'bottomleft'
                }).addTo(this.map);

                console.log('üó∫Ô∏è Map initialized');
            }

            setupEventListeners() {
                // Trail toggle
                document.getElementById('trailToggle').addEventListener('click', (e) => {
                    this.toggleTrails();
                });

                // Handle page visibility change
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && (!this.websocket || this.websocket.readyState !== WebSocket.OPEN)) {
                        this.connectWebSocket();
                    }
                });

                // Map click to hide popup and stop tracking
                this.map.on('click', () => {
                    this.hideLocationPopup();
                });

                // Map move events - stop tracking if user manually moves map
                this.map.on('dragstart', () => {
                    if (this.isTracking) {
                        this.showNotification('Manual map movement detected - tracking paused', 'warning');
                    }
                });
            }

            connectWebSocket() {
                const wsUrls = [
                    'ws://localhost:8080',
                    'ws://127.0.0.1:8080',
                    `ws://${window.location.hostname}:8080`
                ];

                this.updateConnectionStatus('connecting');
                
                const wsUrl = wsUrls[this.reconnectAttempts % wsUrls.length];
                console.log(`üîó Connecting to: ${wsUrl}`);

                try {
                    this.websocket = new WebSocket(wsUrl);
                    
                    this.websocket.onopen = () => {
                        console.log('‚úÖ WebSocket connected');
                        this.updateConnectionStatus('connected');
                        this.reconnectAttempts = 0;
                        
                        // Identify as web client
                        this.sendMessage({
                            type: 'web_client_connect',
                            timestamp: new Date().toISOString()
                        });

                        this.refreshData();
                    };
                    
                    this.websocket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleServerMessage(data);
                        } catch (error) {
                            console.error('‚ùå Failed to parse message:', error);
                        }
                    };
                    
                    this.websocket.onclose = (event) => {
                        console.log('üîå WebSocket disconnected');
                        this.updateConnectionStatus('disconnected');
                        
                        if (this.reconnectAttempts < this.maxReconnectAttempts) {
                            this.reconnectAttempts++;
                            const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
                            setTimeout(() => this.connectWebSocket(), delay);
                        }
                    };
                    
                    this.websocket.onerror = (error) => {
                        console.error('‚ùå WebSocket error:', error);
                        this.updateConnectionStatus('disconnected');
                    };
                    
                } catch (error) {
                    console.error('‚ùå WebSocket connection error:', error);
                    this.updateConnectionStatus('disconnected');
                }
            }

            sendMessage(data) {
                if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                    this.websocket.send(JSON.stringify(data));
                }
            }

            handleServerMessage(data) {
                switch (data.type) {
                    case 'initial_data':
                        this.handleInitialData(data);
                        break;

                    case 'device_connected':
                        this.handleDeviceConnected(data);
                        break;

                    case 'device_disconnected':
                        this.handleDeviceDisconnected(data);
                        break;

                    case 'location_update':
                        this.handleLocationUpdate(data);
                        break;

                    case 'device_status':
                        this.handleDeviceStatus(data);
                        break;

                    case 'location_error':
                        this.handleLocationError(data);
                        break;

                    case 'welcome':
                        console.log('üëã Connected to server');
                        break;
                }
            }

            handleInitialData(data) {
                console.log('üìä Initial data received');
                
                if (data.devices && Array.isArray(data.devices)) {
                    this.devices.clear();
                    data.devices.forEach(device => {
                        this.devices.set(device.deviceId, device);
                        this.updateDeviceOnMap(device);
                    });
                }

                if (data.stats) {
                    this.updateStats(data.stats);
                }

                this.renderDeviceList();
                this.centerAllDevices();
            }

            handleDeviceConnected(data) {
                console.log('üì± Device connected:', data.device?.deviceName);
                
                if (data.device) {
                    this.devices.set(data.device.deviceId, data.device);
                    this.updateDeviceOnMap(data.device);
                    this.renderDeviceList();
                    this.showNotification(`Device connected: ${data.device.deviceName}`, 'success');
                    
                    // Auto-track if enabled and first online device
                    if (this.autoFollow && !this.isTracking && data.device.isOnline) {
                        this.startTracking(data.device.deviceId);
                    }
                }
            }

            handleDeviceDisconnected(data) {
                console.log('üì± Device disconnected');
                
                const device = this.devices.get(data.deviceId);
                if (device) {
                    device.isOnline = false;
                    device.disconnectedAt = new Date().toISOString();
                    this.updateDeviceOnMap(device);
                    this.renderDeviceList();
                    this.showNotification(`Device disconnected: ${device.deviceName}`, 'warning');
                    
                    // Stop tracking if this device was being tracked
                    if (this.trackedDevice === data.deviceId) {
                        this.stopTracking();
                    }
                }
            }

            handleLocationUpdate(data) {
                console.log('üìç Location update:', data.deviceName);
                
                let device = this.devices.get(data.deviceId);
                if (!device) {
                    // Create new device if not exists
                    device = {
                        deviceId: data.deviceId,
                        deviceName: data.deviceName || 'Unknown Device',
                        isOnline: true,
                        lastSeen: new Date().toISOString()
                    };
                    this.devices.set(data.deviceId, device);
                }

                // Store previous location for speed calculation
                const previousLocation = device.location;

                // Update device location
                device.location = data.location;
                device.lastSeen = data.location.timestamp;
                device.isOnline = true;

                // Calculate movement if we have previous location
                if (previousLocation && this.trackedDevice === data.deviceId) {
                    const distance = this.calculateDistance(
                        previousLocation.latitude, previousLocation.longitude,
                        data.location.latitude, data.location.longitude
                    );
                    const timeDiff = (new Date(data.location.timestamp) - new Date(previousLocation.timestamp)) / 1000;
                    device.calculatedSpeed = distance / timeDiff * 3.6; // km/h
                }

                // Update map
                this.updateDeviceOnMap(device);
                this.addLocationToTrail(data.deviceId, data.location);
                
                // Handle live tracking
                if (this.isTracking && this.trackedDevice === data.deviceId) {
                    this.updateTracking(device);
                }
                
                // Update UI
                this.locationUpdates++;
                this.renderDeviceList();
                this.updateStats();

                // Show brief notification for first location
                if (!device.hasShownFirstLocation) {
                    device.hasShownFirstLocation = true;
                    this.showNotification(`Location received from ${device.deviceName}`, 'success');
                }
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371000; // Earth's radius in meters
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            startTracking(deviceId) {
                const device = this.devices.get(deviceId);
                if (!device || !device.isOnline || !device.location) {
                    this.showNotification('Cannot track: device offline or no location', 'error');
                    return;
                }

                this.isTracking = true;
                this.trackedDevice = deviceId;
                this.lastTrackingUpdate = new Date();
                
                // Update UI
                this.updateTrackingControls();
                this.renderDeviceList();
                
                // Center on device with smooth animation
                this.smoothPanTo(device.location.latitude, device.location.longitude, this.trackingZoom);
                
                this.showNotification(`Started tracking ${device.deviceName}`, 'success');
                console.log(`üéØ Started tracking: ${device.deviceName}`);
            }

            stopTracking() {
                if (!this.isTracking) return;
                
                const device = this.devices.get(this.trackedDevice);
                this.isTracking = false;
                this.trackedDevice = null;
                this.autoFollow = false;
                
                // Update UI
                this.updateTrackingControls();
                this.renderDeviceList();
                
                this.showNotification(`Stopped tracking ${device?.deviceName || 'device'}`, 'warning');
                console.log('‚èπÔ∏è Stopped tracking');
            }

            updateTracking(device) {
                if (!this.isTracking || this.trackedDevice !== device.deviceId || !device.location) {
                    return;
                }

                // Smooth pan to new location
                this.smoothPanTo(device.location.latitude, device.location.longitude);
                
                // Update last tracking time
                this.lastTrackingUpdate = new Date();
            }

            smoothPanTo(lat, lng, zoom = null) {
                const currentZoom = this.map.getZoom();
                const targetZoom = zoom || Math.max(currentZoom, 15);
                
                // Use flyTo for smooth animation
                this.map.flyTo([lat, lng], targetZoom, {
                    animate: true,
                    duration: this.trackingSmoothness,
                    easeLinearity: 0.1
                });
            }

            autoFollowOnline() {
                const onlineDevices = Array.from(this.devices.values()).filter(d => d.isOnline && d.location);
                
                if (onlineDevices.length === 0) {
                    this.showNotification('No online devices with location found', 'warning');
                    return;
                }

                // If already tracking, stop
                if (this.isTracking) {
                    this.stopTracking();
                    return;
                }

                // Find the most recently updated online device
                const mostRecent = onlineDevices.reduce((latest, device) => {
                    return new Date(device.lastSeen) > new Date(latest.lastSeen) ? device : latest;
                });

                this.autoFollow = true;
                this.startTracking(mostRecent.deviceId);
            }

            focusDevice(deviceId) {
                const device = this.devices.get(deviceId);
                if (!device || !device.location) {
                    this.showNotification('Device has no location data', 'warning');
                    return;
                }

                this.selectDevice(deviceId);
                this.smoothPanTo(device.location.latitude, device.location.longitude, 16);
                this.showNotification(`Focused on ${device.deviceName}`, 'success');
            }

            updateTrackingControls() {
                const trackingControls = document.getElementById('trackingControls');
                const trackingDeviceName = document.getElementById('trackingDeviceName');
                
                if (this.isTracking && this.trackedDevice) {
                    const device = this.devices.get(this.trackedDevice);
                    trackingControls.style.display = 'block';
                    trackingDeviceName.textContent = device?.deviceName || 'Unknown Device';
                } else {
                    trackingControls.style.display = 'none';
                }
            }

            handleDeviceStatus(data) {
                const device = this.devices.get(data.deviceId);
                if (device) {
                    device.batteryLevel = data.batteryLevel;
                    device.isCharging = data.isCharging;
                    device.networkType = data.networkType;
                    this.renderDeviceList();
                }
            }

            handleLocationError(data) {
                console.error('‚ùå Location error:', data.error);
                this.showNotification(`Location error from ${data.deviceName}: ${data.error}`, 'error');
            }

            updateDeviceOnMap(device) {
                if (!device.location) return;

                const { latitude, longitude } = device.location;
                const deviceId = device.deviceId;

                // Remove existing marker
                if (this.deviceMarkers.has(deviceId)) {
                    this.map.removeLayer(this.deviceMarkers.get(deviceId));
                }

                // Determine marker class based on status
                let markerClass = device.isOnline ? 'online' : 'offline';
                if (this.isTracking && this.trackedDevice === deviceId) {
                    markerClass = 'tracking';
                }

                // Create custom icon with direction indicator
                const directionArrow = device.location.heading !== undefined ? 
                    `<div class="direction-indicator" style="transform: translateX(-50%) rotate(${device.location.heading}deg);">üìç</div>` : '';

                const iconHtml = `
                    <div class="device-marker ${markerClass}" 
                         style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white; position: relative;">
                        ${device.deviceName.charAt(0).toUpperCase()}
                        ${directionArrow}
                    </div>
                `;

                const customIcon = L.divIcon({
                    html: iconHtml,
                    className: 'custom-marker',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                // Create marker
                const marker = L.marker([latitude, longitude], {
                    icon: customIcon,
                    title: device.deviceName
                }).addTo(this.map);

                // Create popup content
                const popupContent = this.createPopupContent(device);
                marker.bindPopup(popupContent);

                // Handle marker click
                marker.on('click', () => {
                    this.selectDevice(deviceId);
                    this.showLocationDetails(device);
                });

                this.deviceMarkers.set(deviceId, marker);
            }

            createPopupContent(device) {
                const loc = device.location;
                const timestamp = new Date(loc.timestamp).toLocaleString();
                const isTracking = this.isTracking && this.trackedDevice === device.deviceId;
                
                return `
                    <div style="min-width: 250px;">
                        <h4 style="margin: 0 0 10px 0; color: #333;">üì± ${device.deviceName}</h4>
                        <div style="font-size: 0.9em; line-height: 1.4;">
                            <div><strong>Status:</strong> <span style="color: ${device.isOnline ? (isTracking ? '#ff6b35' : '#28a745') : '#dc3545'}">${device.isOnline ? (isTracking ? 'Tracking' : 'Online') : 'Offline'}</span></div>
                            <div><strong>Coordinates:</strong> ${loc.latitude.toFixed(6)}, ${loc.longitude.toFixed(6)}</div>
                            <div><strong>Accuracy:</strong> ¬±${loc.accuracy ? Math.round(loc.accuracy) + 'm' : 'N/A'}</div>
                            <div><strong>Speed:</strong> ${loc.speed ? Math.round(loc.speed * 3.6) + ' km/h' : (device.calculatedSpeed ? Math.round(device.calculatedSpeed) + ' km/h' : '0 km/h')}</div>
                            ${loc.heading !== undefined ? `<div><strong>Direction:</strong> ${Math.round(loc.heading)}¬∞</div>` : ''}
                            <div><strong>Last Update:</strong> ${timestamp}</div>
                            ${device.batteryLevel ? `<div><strong>Battery:</strong> ${device.batteryLevel}%${device.isCharging ? ' (Charging)' : ''}</div>` : ''}
                        </div>
                        ${device.isOnline ? `
                            <div style="margin-top: 10px; display: flex; gap: 5px;">
                                <button onclick="dashboard.focusDevice('${device.deviceId}')" style="padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">Focus</button>
                                <button onclick="dashboard.${isTracking ? 'stopTracking()' : "startTracking('" + device.deviceId + "')"}" style="padding: 4px 8px; background: ${isTracking ? '#dc3545' : '#ff6b35'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">${isTracking ? 'Stop' : 'Track'}</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            addLocationToTrail(deviceId, location) {
                if (!this.showTrails) return;

                if (!this.deviceTrails.has(deviceId)) {
                    this.deviceTrails.set(deviceId, []);
                }

                const trail = this.deviceTrails.get(deviceId);
                trail.push([location.latitude, location.longitude]);

                // Keep only last 100 points
                if (trail.length > 100) {
                    trail.shift();
                }

                // Draw trail
                this.drawTrail(deviceId);
            }

            drawTrail(deviceId) {
                const trail = this.deviceTrails.get(deviceId);
                if (!trail || trail.length < 2) return;

                // Remove existing trail
                if (this.deviceTrails[`${deviceId}_polyline`]) {
                    this.map.removeLayer(this.deviceTrails[`${deviceId}_polyline`]);
                }

                // Create polyline with enhanced styling for tracked device
                const isTracked = this.isTracking && this.trackedDevice === deviceId;
                const polylineOptions = {
                    color: this.getDeviceColor(deviceId),
                    weight: isTracked ? 5 : 3,
                    opacity: isTracked ? 0.9 : 0.7,
                    className: isTracked ? 'tracking-trail' : ''
                };

                // Add dash pattern for tracking trail
                if (isTracked) {
                    polylineOptions.dashArray = '10, 5';
                }

                const polyline = L.polyline(trail, polylineOptions).addTo(this.map);

                this.deviceTrails[`${deviceId}_polyline`] = polyline;
            }

            getDeviceColor(deviceId) {
                const colors = ['#FF5733', '#33FF57', '#3357FF', '#FF33F5', '#F5FF33', '#33FFF5', '#FF8C33', '#8C33FF'];
                const index = Array.from(this.devices.keys()).indexOf(deviceId) % colors.length;
                return colors[index];
            }

            toggleTrails() {
                this.showTrails = !this.showTrails;
                const toggle = document.getElementById('trailToggle');
                toggle.classList.toggle('active', this.showTrails);

                if (this.showTrails) {
                    // Redraw all trails
                    this.deviceTrails.forEach((trail, deviceId) => {
                        if (typeof deviceId === 'string' && !deviceId.includes('_polyline')) {
                            this.drawTrail(deviceId);
                        }
                    });
                    this.showNotification('Location trails enabled', 'success');
                } else {
                    // Remove all trails
                    this.clearTrails();
                    this.showNotification('Location trails disabled', 'warning');
                }
            }

            clearTrails() {
                this.deviceTrails.forEach((trail, key) => {
                    if (typeof key === 'string' && key.includes('_polyline')) {
                        this.map.removeLayer(trail);
                        this.deviceTrails.delete(key);
                    }
                });

                // Clear trail data but keep polyline references
                this.deviceTrails.forEach((trail, deviceId) => {
                    if (Array.isArray(trail)) {
                        this.deviceTrails.set(deviceId, []);
                    }
                });

                this.showNotification('Location trails cleared', 'success');
            }

            clearAllData() {
                if (confirm('Are you sure you want to clear all device data and trails?')) {
                    // Stop tracking first
                    if (this.isTracking) {
                        this.stopTracking();
                    }
                    
                    // Clear devices
                    this.devices.clear();
                    
                    // Clear markers
                    this.deviceMarkers.forEach(marker => {
                        this.map.removeLayer(marker);
                    });
                    this.deviceMarkers.clear();
                    
                    // Clear trails
                    this.clearTrails();
                    
                    // Reset counters
                    this.locationUpdates = 0;
                    
                    // Update UI
                    this.renderDeviceList();
                    this.updateStats();
                    this.hideLocationPopup();
                    
                    this.showNotification('All data cleared', 'success');
                }
            }

            selectDevice(deviceId) {
                this.selectedDevice = deviceId;
                this.renderDeviceList();
                
                const device = this.devices.get(deviceId);
                if (device && device.location) {
                    this.map.setView([device.location.latitude, device.location.longitude], 16);
                }
            }

            centerAllDevices() {
                const locations = [];
                this.devices.forEach(device => {
                    if (device.location) {
                        locations.push([device.location.latitude, device.location.longitude]);
                    }
                });

                if (locations.length === 0) {
                    this.map.setView([-6.2088, 106.8456], 11); // Default to Jakarta
                    return;
                }

                if (locations.length === 1) {
                    this.map.setView(locations[0], 15);
                } else {
                    const group = new L.featureGroup(this.deviceMarkers.values());
                    this.map.fitBounds(group.getBounds().pad(0.1));
                }

                this.showNotification('Centered on all devices', 'success');
            }

            showLocationDetails(device) {
                const popup = document.getElementById('locationPopup');
                const title = document.getElementById('popupTitle');
                const details = document.getElementById('popupDetails');

                title.textContent = `üì± ${device.deviceName}`;

                if (!device.location) {
                    details.innerHTML = '<div>No location data available</div>';
                    popup.classList.add('show');
                    return;
                }

                const loc = device.location;
                const timestamp = new Date(loc.timestamp);
                const isTracking = this.isTracking && this.trackedDevice === device.deviceId;

                details.innerHTML = `
                    <div class="detail-item">
                        <span class="detail-label">Status</span>
                        <span class="detail-value" style="background: ${device.isOnline ? (isTracking ? 'rgba(255, 107, 53, 0.1)' : 'rgba(40, 167, 69, 0.1)') : 'rgba(220, 53, 69, 0.1)'}; color: ${device.isOnline ? (isTracking ? '#ff6b35' : '#28a745') : '#dc3545'}">${device.isOnline ? (isTracking ? 'Tracking' : 'Online') : 'Offline'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Latitude</span>
                        <span class="detail-value">${loc.latitude.toFixed(6)}¬∞</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Longitude</span>
                        <span class="detail-value">${loc.longitude.toFixed(6)}¬∞</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Accuracy</span>
                        <span class="detail-value">¬±${loc.accuracy ? Math.round(loc.accuracy) + 'm' : 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Speed</span>
                        <span class="detail-value">${loc.speed ? Math.round(loc.speed * 3.6) + ' km/h' : (device.calculatedSpeed ? Math.round(device.calculatedSpeed) + ' km/h' : '0 km/h')}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Heading</span>
                        <span class="detail-value">${loc.heading !== undefined ? Math.round(loc.heading) + '¬∞' : 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Altitude</span>
                        <span class="detail-value">${loc.altitude ? Math.round(loc.altitude) + 'm' : 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Last Update</span>
                        <span class="detail-value">${timestamp.toLocaleString()}</span>
                    </div>
                    ${device.batteryLevel !== undefined ? `
                        <div class="detail-item">
                            <span class="detail-label">Battery</span>
                            <span class="detail-value">${device.batteryLevel}%${device.isCharging ? ' ‚ö°' : ''}</span>
                        </div>
                    ` : ''}
                    ${device.networkType ? `
                        <div class="detail-item">
                            <span class="detail-label">Network</span>
                            <span class="detail-value">${device.networkType}</span>
                        </div>
                    ` : ''}
                `;

                popup.classList.add('show');
            }

            hideLocationPopup() {
                document.getElementById('locationPopup').classList.remove('show');
            }

            renderDeviceList() {
                const deviceList = document.getElementById('deviceList');
                
                if (this.devices.size === 0) {
                    deviceList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <div style="font-size: 2em; margin-bottom: 10px;">üì°</div>
                            <div>Waiting for devices...</div>
                            <button class="control-btn" style="margin-top: 10px; width: auto; padding: 8px 16px;" onclick="dashboard.refreshData()">
                                üîÑ Refresh
                            </button>
                        </div>
                    `;
                    return;
                }

                const devicesArray = Array.from(this.devices.values())
                    .sort((a, b) => {
                        // Sort by tracking status first, then online status, then by name
                        if ((this.trackedDevice === a.deviceId) !== (this.trackedDevice === b.deviceId)) {
                            return (this.trackedDevice === b.deviceId) - (this.trackedDevice === a.deviceId);
                        }
                        if (a.isOnline !== b.isOnline) {
                            return b.isOnline - a.isOnline;
                        }
                        return (a.deviceName || '').localeCompare(b.deviceName || '');
                    });

                deviceList.innerHTML = devicesArray.map(device => {
                    const isSelected = this.selectedDevice === device.deviceId;
                    const isTracked = this.isTracking && this.trackedDevice === device.deviceId;
                    const lastSeen = device.lastSeen ? new Date(device.lastSeen).toLocaleTimeString() : 'Never';
                    
                    let deviceClass = device.isOnline ? 'online' : 'offline';
                    if (isTracked) deviceClass = 'tracking';
                    else if (isSelected) deviceClass += ' selected';
                    
                    let statusText = device.isOnline ? 'Online' : 'Offline';
                    let statusClass = device.isOnline ? 'online' : 'offline';
                    if (isTracked) {
                        statusText = 'Tracking';
                        statusClass = 'tracking';
                    }
                    
                    return `
                        <div class="device-item ${deviceClass}" 
                             onclick="dashboard.selectDevice('${device.deviceId}')">
                            <div class="device-name">
                                ${device.deviceName || 'Unknown Device'} ${isTracked ? 'üéØ' : ''}
                                <span class="device-status ${statusClass}">
                                    ${statusText}
                                </span>
                            </div>
                            <div class="device-info">
                                <div><strong>Last seen:</strong> ${lastSeen}</div>
                                ${device.location ? `
                                    <div><strong>Location:</strong> ${device.location.latitude.toFixed(4)}, ${device.location.longitude.toFixed(4)}</div>
                                    <div><strong>Accuracy:</strong> ¬±${device.location.accuracy ? Math.round(device.location.accuracy) + 'm' : 'N/A'}</div>
                                    ${device.location.speed || device.calculatedSpeed ? `<div><strong>Speed:</strong> ${Math.round((device.location.speed || device.calculatedSpeed || 0) * 3.6)} km/h</div>` : ''}
                                ` : '<div style="color: #999;">No location data</div>'}
                                ${device.batteryLevel !== undefined ? `
                                    <div><strong>Battery:</strong> ${device.batteryLevel}%${device.isCharging ? ' ‚ö°' : ''}</div>
                                ` : ''}
                            </div>
                            ${device.isOnline && device.location ? `
                                <div class="device-actions">
                                    <button class="device-btn focus" onclick="event.stopPropagation(); dashboard.focusDevice('${device.deviceId}')">
                                        üéØ Focus
                                    </button>
                                    <button class="device-btn track ${isTracked ? 'active' : ''}" onclick="event.stopPropagation(); dashboard.${isTracked ? 'stopTracking()' : "startTracking('" + device.deviceId + "')"}" title="${isTracked ? 'Stop tracking' : 'Start live tracking'}">
                                        ${isTracked ? '‚èπÔ∏è Stop' : 'üöó Track'}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }

            updateStats(serverStats = null) {
                const onlineDevices = Array.from(this.devices.values()).filter(d => d.isOnline).length;
                const trackingCount = this.isTracking ? 1 : 0;
                
                document.getElementById('deviceCount').textContent = this.devices.size;
                document.getElementById('onlineCount').textContent = onlineDevices;
                document.getElementById('updateCount').textContent = this.locationUpdates;
                document.getElementById('trackingCount').textContent = trackingCount;
                
                if (serverStats && serverStats.uptimeFormatted) {
                    document.getElementById('uptime').textContent = serverStats.uptimeFormatted;
                }
            }

            updateConnectionStatus(status) {
                const statusElement = document.getElementById('connectionStatus');
                statusElement.className = `connection-status ${status}`;
                
                switch (status) {
                    case 'connected':
                        statusElement.innerHTML = 'üü¢ Connected';
                        break;
                    case 'connecting':
                        statusElement.innerHTML = 'üîÑ Connecting...';
                        break;
                    case 'disconnected':
                        statusElement.innerHTML = 'üî¥ Disconnected';
                        break;
                }
            }

            async refreshData() {
                console.log('üîÑ Refreshing data...');
                
                try {
                    const response = await fetch('/api/devices');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            result.data.forEach(device => {
                                this.devices.set(device.deviceId, device);
                                this.updateDeviceOnMap(device);
                            });
                            this.renderDeviceList();
                        }
                    }

                    const statsResponse = await fetch('/api/stats');
                    if (statsResponse.ok) {
                        const statsResult = await statsResponse.json();
                        if (statsResult.success && statsResult.data) {
                            this.updateStats(statsResult.data);
                        }
                    }

                    this.showNotification('Data refreshed successfully', 'success');
                } catch (error) {
                    console.error('‚ùå Failed to refresh data:', error);
                    this.showNotification('Failed to refresh data', 'error');
                }
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 5px;">
                        ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'} 
                        ${type.charAt(0).toUpperCase() + type.slice(1)}
                    </div>
                    <div>${message}</div>
                `;

                document.body.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 100);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 4000);
            }

            hideLoadingOverlay() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        overlay.style.display = 'none';
                    }, 300);
                }
            }

            startPeriodicUpdates() {
                // Send ping every 30 seconds
                setInterval(() => {
                    if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                        this.sendMessage({
                            type: 'ping',
                            timestamp: new Date().toISOString()
                        });
                    } else {
                        this.connectWebSocket();
                    }
                }, 30000);

                // Update device status every 10 seconds
                setInterval(() => {
                    this.devices.forEach((device, deviceId) => {
                        if (device.lastSeen) {
                            const lastSeen = new Date(device.lastSeen);
                            const now = new Date();
                            const diffMinutes = (now - lastSeen) / (1000 * 60);
                            
                            // Mark as offline if no update for 2 minutes
                            if (diffMinutes > 2 && device.isOnline) {
                                device.isOnline = false;
                                this.updateDeviceOnMap(device);
                                this.renderDeviceList();
                                
                                // Stop tracking if this device goes offline
                                if (this.trackedDevice === deviceId) {
                                    this.stopTracking();
                                }
                            }
                        }
                    });
                    
                    // Check for tracking timeout
                    if (this.isTracking && this.lastTrackingUpdate) {
                        const trackingAge = (new Date() - this.lastTrackingUpdate) / 1000;
                        if (trackingAge > 120) { // 2 minutes without update
                            this.showNotification('No tracking updates received - stopping tracking', 'warning');
                            this.stopTracking();
                        }
                    }
                }, 10000);

                // Update local time every second
                setInterval(() => {
                    this.updateLocalTime();
                }, 1000);
            }

            updateLocalTime() {
                // This could be used to show relative timestamps
                // For now, we'll just update the stats periodically
                this.updateStats();
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new RealtimeMapDashboard();
        });

        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'r':
                        e.preventDefault();
                        dashboard.refreshData();
                        break;
                    case 't':
                        e.preventDefault();
                        dashboard.toggleTrails();
                        break;
                    case 'c':
                        e.preventDefault();
                        dashboard.centerAllDevices();
                        break;
                    case 'f':
                        e.preventDefault();
                        dashboard.autoFollowOnline();
                        break;
                }
            }
            
            // ESC key to stop tracking or hide popup
            if (e.key === 'Escape') {
                if (dashboard.isTracking) {
                    dashboard.stopTracking();
                } else {
                    dashboard.hideLocationPopup();
                }
            }
            
            // Space bar to toggle tracking on selected device
            if (e.code === 'Space' && dashboard.selectedDevice) {
                e.preventDefault();
                const device = dashboard.devices.get(dashboard.selectedDevice);
                if (device && device.isOnline) {
                    if (dashboard.isTracking && dashboard.trackedDevice === dashboard.selectedDevice) {
                        dashboard.stopTracking();
                    } else {
                        dashboard.startTracking(dashboard.selectedDevice);
                    }
                }
            }
        });

        // Add touch support for mobile devices
        document.addEventListener('touchstart', (e) => {
            // Handle touch events for better mobile experience
        }, { passive: true });

        // Handle orientation change on mobile
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                if (dashboard.map) {
                    dashboard.map.invalidateSize();
                    if (dashboard.isTracking && dashboard.trackedDevice) {
                        const device = dashboard.devices.get(dashboard.trackedDevice);
                        if (device && device.location) {
                            dashboard.smoothPanTo(device.location.latitude, device.location.longitude);
                        }
                    }
                }
            }, 100);
        });
    </script>
</body>
</html>